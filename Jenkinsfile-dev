pipeline {
  agent any
  environment {
    SONARQUBE_SERVER   = 'sonar'        // debe coincidir con el Name de Sonar en Jenkins
    ENV_NAME           = 'dev'
    SONAR_BACKEND_KEY  = 'backend-dev'
    SONAR_FRONTEND_KEY = 'frontend-dev'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build backend (Maven + tests)') {
      steps {
        script {
          docker.image('maven:3.9-eclipse-temurin-17').inside('--network ci-network') {
            sh """
              cd backend
              mvn clean verify -DskipTests=false
            """
          }
        }
      }
    }

    stage('SonarQube backend') {
      steps {
        script {
          docker.image('maven:3.9-eclipse-temurin-17').inside('--network ci-network') {
            withSonarQubeEnv("${SONARQUBE_SERVER}") {
              sh """
                cd backend && mvn sonar:sonar \
                  -Dsonar.projectKey=${SONAR_BACKEND_KEY} \
                  -Dsonar.host.url=$SONAR_HOST_URL
              """
            }
          }
        }
      }
    }

    stage('Build frontend (Node + tests)') {
      steps {
        script {
          docker.image('node:20').inside('--network ci-network') {
            sh """
              cd frontend
              npm install
              npm run test || echo "sin tests definidos para FE"
              npm run build
            """
          }
        }
      }
    }

    stage('SonarQube frontend') {
      steps {
        script {
          docker.image('sonarsource/sonar-scanner-cli:5.0.1').inside('--network ci-network') {
            withSonarQubeEnv("${SONARQUBE_SERVER}") {
              sh """
                cd frontend && sonar-scanner \
                  -Dsonar.projectKey=${SONAR_FRONTEND_KEY} \
                  -Dsonar.sources=src \
                  -Dsonar.host.url=$SONAR_HOST_URL
              """
            }
          }
        }
      }
    }

    stage('Build Docker images') {
      steps {
        sh """
          docker build -t aerolineas-backend-${ENV_NAME} backend
          docker build -t aerolineas-frontend-${ENV_NAME} frontend
        """
      }
    }

    stage('Stop & Remove old containers') {
      steps {
        sh """
          docker stop backend-dev || true
          docker rm backend-dev || true

          docker stop frontend-dev || true
          docker rm frontend-dev || true
        """
      }
    }

    stage('Deploy ambiente dev') {
      steps {
        sh """
          docker start oracle-xe || true
          docker run -d --name backend-dev --network ci-network -p 8081:8080 aerolineas-backend-dev
          docker run -d --name frontend-dev --network ci-network -p 8084:80 aerolineas-frontend-dev
        """
      }
    }

  } // stages

  post {
    failure {
      emailext(
        subject: "Fall√≥ pipeline DEV",
        body: """
Hola equipo,

El pipeline DEV ha fallado.
Por favor revisar los logs en Jenkins.

Enlace al build:
${env.BUILD_URL}

Saludos,
DevTeam
""",
        to: "msblanco@unis.edu.gt, kdieguez@unis.edu.gt, dnatareno@unis.edu.gt"
      )
    }
  }
}
