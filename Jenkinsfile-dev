pipeline {
  agent any

  environment {
    SONARQUBE_SERVER   = 'sonar'        // debe coincidir con el Name de Sonar en Jenkins
    ENV_NAME           = 'dev'
    SONAR_BACKEND_KEY  = 'backend-dev'
    SONAR_FRONTEND_KEY = 'frontend-dev'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build backend (Maven + tests)') {
      steps {
        script {
          docker.image('maven:3.9-eclipse-temurin-17').inside('--network ci-network') {
            sh """
              cd backend
              mvn clean verify -DskipTests=false
            """
          }
        }
      }
    }

    stage('SonarQube backend') {
      steps {
        script {
          docker.image('maven:3.9-eclipse-temurin-17').inside('--network ci-network') {
            withSonarQubeEnv("${SONARQUBE_SERVER}") {
              sh """
                cd backend
                mvn sonar:sonar \
                  -Dsonar.projectKey=${SONAR_BACKEND_KEY} \
                  -Dsonar.host.url=$SONAR_HOST_URL
              """
            }
          }
        }
      }
    }

    stage('Build frontend (Node + tests)') {
      steps {
        script {
          docker.image('node:20').inside('--network ci-network') {
            sh """
              cd frontend
              npm install
              npm run test || echo "sin tests definidos para FE"
              npm run build
            """
          }
        }
      }
    }

    stage('SonarQube frontend') {
      steps {
        script {
          // Usamos la imagen oficial del scanner en vez de una tool de Jenkins
          docker.image('sonarsource/sonar-scanner-cli:5.0.1').inside('--network ci-network') {
            withSonarQubeEnv("${SONARQUBE_SERVER}") {
              sh """
                cd frontend
                sonar-scanner \
                  -Dsonar.projectKey=${SONAR_FRONTEND_KEY} \
                  -Dsonar.sources=src \
                  -Dsonar.host.url=$SONAR_HOST_URL
              """
            }
          }
        }
      }
    }

    stage('Build Docker images') {
      steps {
        sh """
          docker build -t aerolineas-backend-${ENV_NAME} backend
          docker build -t aerolineas-frontend-${ENV_NAME} frontend
        """
      }
    }

    stage('Deploy ambiente dev') {
      steps {
        sh """
          docker start oracle-xe || true
          docker start backend-dev  || true
          docker start frontend-dev || true
        """
      }
    }
  }
}
