---
kind: pipeline
type: docker
name: dev

steps:
  - name: backend-tests-and-sonar-dev
    image: maven:3.9-eclipse-temurin-17
    environment:
      SONAR_TOKEN:
        from_secret: sonar_token
      SONAR_HOST_URL:
        from_secret: sonar_host_url
    commands:
      - cd backend
      # Tests + Sonar + Quality Gate (dev)
      - mvn -B -DskipTests=false clean verify sonar:sonar -Dsonar.login=$SONAR_TOKEN -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.qualitygate.wait=true
    when:
      branch:
        - dev
      event:
        - push
        - pull_request

  - name: frontend-tests-dev
    image: node:20
    commands:
      - cd frontend
      - npm ci
      - npm test -- --watch=false
    when:
      branch:
        - dev
      event:
        - push
        - pull_request

  - name: build-images-dev
    image: docker:26-cli
    volumes:
      - name: docker_sock
        path: /var/run/docker.sock
    commands:
      - docker build -t aerolineas-backend-dev ./backend
      - docker build -t aerolineas-frontend-dev ./frontend
    when:
      branch:
        - dev
      event:
        - push          # solo después de push a dev

  - name: deploy-dev
    image: docker:26-cli
    volumes:
      - name: docker_sock
        path: /var/run/docker.sock
    commands:
      - docker stop backend-dev frontend-dev || true
      - docker rm backend-dev frontend-dev || true

      - docker run -d --name backend-dev -p 8081:8080 aerolineas-backend-dev
      - docker run -d --name frontend-dev -p 8084:80 aerolineas-frontend-dev
    when:
      branch:
        - dev
      event:
        - push          # deploy solo en push a dev

  # enviar correo si algo del pipeline falla (dev)
  - name: notify-failure-email-dev
    image: drillster/drone-email
    settings:
      host:
        from_secret: smtp_host
      username:
        from_secret: smtp_user
      password:
        from_secret: smtp_password
      from:
        from_secret: smtp_from
      recipients:
        from_secret: notify_to
      subject: "[Drone][DEV] Falló pipeline ${DRONE_REPO_NAME} #${DRONE_BUILD_NUMBER}"
      body: >
        Hola,
        el pipeline (DEV) del repositorio ${DRONE_REPO_NAME} ha fallado.
        Rama: ${DRONE_BRANCH}
        Autor: ${DRONE_COMMIT_AUTHOR}
        Mensaje del commit: ${DRONE_COMMIT_MESSAGE}
        Estado: ${DRONE_BUILD_STATUS}
        Revisa el detalle aquí: ${DRONE_BUILD_LINK}
    when:
      status:
        - failure
      branch:
        - dev

# Usamos el Docker del host (NO DIND) también en dev
volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock

trigger:
  branch:
    - dev
  event:
    - push
    - pull_request
